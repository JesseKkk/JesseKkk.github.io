---
title: 监听器
categories:
  - JavaWeb入门
  - 04_Java-Web进阶
tags:
  - imooc
abbrlink: 33706
date: 2020-02-25 20:44:22
---

:star2:本文是监听器的学习总结:star2:

<!-- more -->

## 1 监听器

### 1.1 什么是监听器

![图片](/images/024_05_01.png)

### 1.2 三个监听对象

![图片](/images/024_05_02.png)

### 1.3 过滤器和监听器的区别

![图片](/images/024_05_03.png)

### 1.4 监听器开发三要素

![图片](/images/024_05_04.png)

### 1.5 第一个监听器

```java
package com.jesse.listener;

import javax.servlet.ServletContextEvent;
import javax.servlet.ServletContextListener;
import javax.servlet.annotation.WebListener;
//@WebListener
public class FirstListener implements ServletContextListener {

    @Override
    public void contextDestroyed(ServletContextEvent arg0) {
        // TODO Auto-generated method stub
        System.out.println("ServletContext已销毁");
    }

    @Override
    public void contextInitialized(ServletContextEvent arg0) {
        // TODO Auto-generated method stub
        System.out.println("ServletContext已初始化");
    }

}
```

```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://xmlns.jcp.org/xml/ns/javaee" xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd" id="WebApp_ID" version="3.1">
  <display-name>first-listener</display-name>
  <welcome-file-list>
    <welcome-file>index.html</welcome-file>
    <welcome-file>index.htm</welcome-file>
    <welcome-file>index.jsp</welcome-file>
    <welcome-file>default.html</welcome-file>
    <welcome-file>default.htm</welcome-file>
    <welcome-file>default.jsp</welcome-file>
  </welcome-file-list>
  <listener>
      <listener-class>com.jesse.listener.FirstListener</listener-class>
  </listener>
</web-app>
```

### 1.6 内置对象监听接口

![图片](/images/024_05_05.png)

#### 1.6.1 Example

```java
package com.jesse.listener;

import java.io.IOException;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/**
 * Servlet implementation class HelloServlet
 */
@WebServlet("/hello")
public class HelloServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;

    /**
     * @see HttpServlet#HttpServlet()
     */
    public HelloServlet() {
        super();
        // TODO Auto-generated constructor stub
    }

    /**
     * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
     */
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // TODO Auto-generated method stub
        response.getWriter().println("Hello World!");
        request.getServletContext().setAttribute("sc-attr1", "sc-attr-value1");
        request.getSession().setAttribute("session-attr1", "session-attr-value1");
        request.setAttribute("request-attr1", "request-attr-value1");
    }

    /**
     * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
     */
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // TODO Auto-generated method stub
        doGet(request, response);
    }

}
```

```java
package com.jesse.listener;

import javax.servlet.ServletContextEvent;
import javax.servlet.ServletContextListener;
import javax.servlet.ServletRequestEvent;
import javax.servlet.ServletRequestListener;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;
import javax.servlet.http.HttpSessionEvent;
import javax.servlet.http.HttpSessionListener;

public class WebListener implements ServletContextListener, HttpSessionListener, ServletRequestListener {

    @Override
    public void requestDestroyed(ServletRequestEvent sre) {
        // TODO Auto-generated method stub
        System.out.println("HttpServletRequest已销毁");

    }

    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        // TODO Auto-generated method stub
        HttpServletRequest req = (HttpServletRequest)sre.getServletRequest();
        System.out.println("HttpServletRequest已被创建，URI: " + req.getRequestURI());
    }

    @Override
    public void sessionCreated(HttpSessionEvent arg0) {
        // TODO Auto-generated method stub
        HttpSession session = arg0.getSession();
        System.out.println("Session已被创建，SessionId: " + session.getId());

    }

    @Override
    public void sessionDestroyed(HttpSessionEvent arg0) {
        // TODO Auto-generated method stub
        System.out.println("Session已销毁");

    }

    @Override
    public void contextDestroyed(ServletContextEvent arg0) {
        // TODO Auto-generated method stub
        System.out.println("ServletContext已销毁");

    }

    @Override
    public void contextInitialized(ServletContextEvent arg0) {
        // TODO Auto-generated method stub
        System.out.println("ServletContext已初始化");
    }

}
```

```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://xmlns.jcp.org/xml/ns/javaee" xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd" id="WebApp_ID" version="3.1">
  <display-name>listener-interface</display-name>
  <welcome-file-list>
    <welcome-file>index.html</welcome-file>
    <welcome-file>index.htm</welcome-file>
    <welcome-file>index.jsp</welcome-file>
    <welcome-file>default.html</welcome-file>
    <welcome-file>default.htm</welcome-file>
    <welcome-file>default.jsp</welcome-file>
  </welcome-file-list>
  <listener>
      <listener-class>com.jesse.listener.WebListener</listener-class>
  </listener>
</web-app>
```

### 1.7 属性监听器

![图片](/images/024_05_06.png)

#### 1.7.1 Example

```java
package com.jesse.listener;

import javax.servlet.ServletContextAttributeEvent;
import javax.servlet.ServletContextAttributeListener;
import javax.servlet.ServletRequestAttributeEvent;
import javax.servlet.ServletRequestAttributeListener;
import javax.servlet.http.HttpSessionAttributeListener;
import javax.servlet.http.HttpSessionBindingEvent;

public class WebAttributeListener implements ServletContextAttributeListener,HttpSessionAttributeListener,ServletRequestAttributeListener {

    @Override
    public void attributeAdded(ServletContextAttributeEvent arg0) {
        // TODO Auto-generated method stub
        System.out.println("ServletContext新增属性：" +  arg0.getName() + "->"  + arg0.getValue());
    }

    @Override
    public void attributeRemoved(ServletContextAttributeEvent arg0) {
        // TODO Auto-generated method stub

    }

    @Override
    public void attributeReplaced(ServletContextAttributeEvent arg0) {
        // TODO Auto-generated method stub

    }

    @Override
    public void attributeAdded(HttpSessionBindingEvent event) {
        // TODO Auto-generated method stub
        System.out.println("HttpSession新增属性：" +  event.getName() + "->"  + event.getValue());

    }

    @Override
    public void attributeRemoved(HttpSessionBindingEvent event) {
        // TODO Auto-generated method stub

    }

    @Override
    public void attributeReplaced(HttpSessionBindingEvent event) {
        // TODO Auto-generated method stub

    }

    @Override
    public void attributeAdded(ServletRequestAttributeEvent arg0) {
        // TODO Auto-generated method stub
        System.out.println("ServletRequest新增属性：" +  arg0.getName() + "->"  + arg0.getValue());

    }

    @Override
    public void attributeRemoved(ServletRequestAttributeEvent arg0) {
        // TODO Auto-generated method stub

    }

    @Override
    public void attributeReplaced(ServletRequestAttributeEvent arg0) {
        // TODO Auto-generated method stub

    }

}
```

## 2 案例：请求流量分析

### 2.1 案例展示

![图片](/images/024_05_06.png)

### 2.2 源码

```java
package com.jesse.total;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import javax.servlet.ServletContextEvent;
import javax.servlet.ServletContextListener;
import javax.servlet.ServletRequestEvent;
import javax.servlet.ServletRequestListener;
import javax.servlet.http.HttpServletRequest;

public class RequestTotalListener implements ServletContextListener, ServletRequestListener  {

    @Override
    public void requestDestroyed(ServletRequestEvent sre) {
        // TODO Auto-generated method stub
    }

    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        HttpServletRequest request = (HttpServletRequest)sre.getServletRequest();
        String url = request.getRequestURL().toString();
        if(url.endsWith("/rt") == true || url.endsWith("total.html")) {
            return;
        }
        // TODO Auto-generated method stub
        //TimeList: 10:02  10:03 10:04  10:05
        //ValueList:   5        7      10
        List<String> timeList = (List)sre.getServletContext().getAttribute("timeList");
        List<Integer> valueList = (List)sre.getServletContext().getAttribute("valueList");
        Date date = new Date();
        SimpleDateFormat sdf = new SimpleDateFormat("HH:mm");
        String time = sdf.format(date);
        if(timeList.indexOf(time) == -1) {
            timeList.add(time);
            valueList.add(1);
            sre.getServletContext().setAttribute("timelist", timeList);
            sre.getServletContext().setAttribute("valueList", valueList);
        }else {
            int index = timeList.indexOf(time);
            int value = valueList.get(index);
            valueList.set(index, value+1);
            sre.getServletContext().setAttribute("valueList", valueList);
        }
    }

    @Override
    public void contextDestroyed(ServletContextEvent sce) {
        // TODO Auto-generated method stub

    }

    @Override
    public void contextInitialized(ServletContextEvent sce) {
        // TODO Auto-generated method stub
        List<String> timeList = new ArrayList<String>();
        List<Integer> valueList = new ArrayList<Integer>();
        sce.getServletContext().setAttribute("timeList", timeList);
        sce.getServletContext().setAttribute("valueList", valueList);
    }

}
```

```java
package com.jesse.total;

import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.alibaba.fastjson.JSON;

/**
 * Servlet implementation class RequestTotalServlet
 */
@WebServlet("/rt")
public class RequestTotalServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;

    /**
     * @see HttpServlet#HttpServlet()
     */
    public RequestTotalServlet() {
        super();
        // TODO Auto-generated constructor stub
    }

    /**
     * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
     */
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // TODO Auto-generated method stub
        ServletContext context = request.getServletContext();
        List<String> timeList = (List)context.getAttribute("timeList");
        List<Integer> valueList = (List)context.getAttribute("valueList");
        response.setContentType("text/html;charset=UTF-8");
//        response.getWriter().println(timeList.toString());
//        response.getWriter().println("<br>");
//        response.getWriter().println(valueList.toString());

        Map<String,List> result = new HashMap<String,List>();
        result.put("timeList", timeList);
        result.put("valueList", valueList);
        String json = JSON.toJSONString(result);
        response.getWriter().println(json);
    }

    /**
     * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
     */
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // TODO Auto-generated method stub
        doGet(request, response);
    }

}
```

```html
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script type="text/javascript" src="js/echarts.min.js"></script>
<script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
</head>
<body>
    <!-- 为ECharts准备一个具备大小（宽高）的Dom -->
    <div id="main" style="width: 600px;height:400px;"></div>
    <script type="text/javascript">
        function showChart(){
            $.ajax({
                url: "./rt",
                type: "get",
                dataType: "json",
                success: function(json){
                    console.log(json.timeList);
                    console.log(json.valueList);

                    var myChart = echarts.init(document.getElementById('main'));
                    var option = {
                        title: {
                            text: '请求流量分析统计'
                        },
                        tooltip: {},
                        legend: {
                            data:['访问量']
                        },
                        xAxis: {
                            data: json.timeList
                        },
                        yAxis: {},
                        series: [{
                            name: '访问量',
                            type: 'line',
                            data: json.valueList
                        }]
                    };
                    myChart.setOption(option);
                }
            })
        }

        window.setInterval("showChart()", 1000);
    </script>
</body>
</html>
```

## 3 案例：静态数据预加载

```java
package com.jesse.listener.entity;

public class Channel {
    private String channelName;
    private String url;

    public Channel() {
    }

    public Channel(String channelName, String url) {
        super();
        this.channelName = channelName;
        this.url = url;
    }
    public String getChannelName() {
        return channelName;
    }
    public void setChannelName(String channelName) {
        this.channelName = channelName;
    }
    public String getUrl() {
        return url;
    }
    public void setUrl(String url) {
        this.url = url;
    }

}
```

```java
package com.jesse.listener;

import java.util.ArrayList;
import java.util.List;

import javax.servlet.ServletContextEvent;
import javax.servlet.ServletContextListener;

import com.jesse.listener.entity.Channel;

public class StaticDataListener implements ServletContextListener {

    @Override
    public void contextDestroyed(ServletContextEvent sce) {
        // TODO Auto-generated method stub

    }

    @Override
    public void contextInitialized(ServletContextEvent sce) {
        // TODO Auto-generated method stub
        List<Channel> list = new ArrayList<Channel>();
        list.add(new Channel("免费课程", "http://www.jesse.com/1"));
        list.add(new Channel("实战课程", "http://www.jesse.com/2"));
        list.add(new Channel("就业班", "http://www.jesse.com/3"));
        sce.getServletContext().setAttribute("channelList", list);
    }

}
```

```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
<c:forEach items="${applicationScope.channelList }" var="c">
    <a href="${c.url }">${c.channelName }</a> |
</c:forEach>
<hr/>
</body>
</html>
```
